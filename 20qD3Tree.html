<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="//d3js.org/d3.v3.min.js"></script>
</head>

<style>
	.parag {
		font-family: sans-serif;
		font-size: 18px;
	}
	#symptoms {
		font-family: sans-serif;
		font-size: 15px;
	}
	div.questionD {
		float: left;
		position: relative;
    	left: 10px;
    	width:500px;
    	height: 60px;
	}
	div.buttonD {
		position: relative;
		left: 220px;
		width: 70px;
	}
	div.symptomsD {
		float:right;
		text-align: right;
		padding-right: 30px;
		height: 150px;
	}


</style>
	
<body>

	<div class = "questionD">
	<center><p id="question" class = "parag"></p></center>
	</div> 
	
	<div class="symptomsD">
	<p id="symptoms"></p>
	</div>
	
	<div class = "buttonD">
		<button class="button" onClick = "yesResponse()" id="yesButton">Yes</button>
		<button class="button"  onClick = "noResponse()" id="noButton">No</button>
	</div>
	
	<div class = "answerD">
	<center><p id= "answer" class = "parag"></p></center>
	</div>
	
	<script>

	//MAJOR FUTURE GOALS:
		//-connect circles to yes/no answers
				//-make circles that have been validated move up, proved wrong move down
				//-change shade of color of circles depending
		//-fix text once clicked to have different line per element
		//-find a better way to organize circles per chapter
			//-instead of columns, put small circles into one larger circle (?)
			
				
	
	//import tree data
	d3.json("treeOfPerfection.json", function(error, data){
		root = data;
		document.getElementById("question").innerHTML = "Does the patient display problems with " + root.rule.substr(0, root.rule.indexOf('<')-1) + '?';
	});
	
	var root;
	var header; 
	var diagnoses;
	var numChapters = 19;
	var chapterOrg = [];
	
	//use this to create the text for the log
	var symptomText = "<em>Log of Symptoms:</em> <br>";
	
	document.getElementById("symptoms").innerHTML = symptomText;

	//import code data
	d3.json("codesShort.json", function(error, data){
		header = data.header;
		diagnoses = data.diagnoses;
		
		index = 0;
		for(i=0; i<diagnoses.length; i++){
			//add common size of circles to start and text to be displayed
			diagnoses[i].size = 20;
			diagnoses[i].text = diagnoses[i].nameCode;
			
			//look through and make a list of symptom categories
			symptCat = [];
			currCode = diagnoses[i].code;
			for(j=0;j<currCode.length;j++){
				if(currCode[j] == 1){
					//add symptom corresponding to code
					symptCat.push(header[j]);
				}
			}
			diagnoses[i].symptoms = symptCat;
		}
		//organize all diagnoses by chapter
		var tempChapterArr = [];
		for(i=0; i<numChapters+1; i++){
			for(j=0; j<diagnoses.length; j++){
				if(diagnoses[j].chapter == i){
					tempChapterArr.push(diagnoses[j]);
					diagnoses[j].index = tempChapterArr.length;
				}
			}
			//chapter Org is a list of lists organized by chapter
			chapterOrg.push(tempChapterArr);
			tempChapterArr = [];
		}
	
		//TO WORK ON:
		//move circle object to front when clicked on. Also need to move the text even more in front
		// d3.selection.prototype.moveToFront = function() {
//  			 return this.each(function(){
//    			 this.parentNode.appendChild(this);
//  			 });
// 		};
	
		//create SVG container			
		var svg = d3.select("body").append("svg")
			.attr("width",1500)
			.attr("height",1500);
			
		var elem = svg.selectAll("circle")
        .data(diagnoses);
        
        var elemEnter = elem.enter()
	    .append("g");
		
		//circle elements created and organized column wise by chapter
		var circle = elemEnter.append("circle")
    		.style("fill", "aqua")
    		.attr("stroke","black")
    		.on("click", function(d) {zoom(d)})
    		.attr("cx", function(d){return d.chapter*50})
			.attr("cy", function(d) {return d.index*50})
    		.attr("r", function(d){return d.size});
				    	
		//text elements with code added to circles   	
		elemEnter.append("text")
	    .attr("dx", function(d){return d.chapter*50})
	    .attr("dy", function(d) {return d.index*50})
	    .style("font-size","10px")
	    .style("text-anchor", "middle")
	    .text(function(d){return d.text});		
							
	});

	//called when an element is clicked on, changes size and text of circle
	function zoom(d){
		if(d.size == 20){
			d.size = 50;
			d.text = d.symptoms;
		}
		else{
			d.size = 20;
			d.text = d.nameCode;
			
		}	
		
		d3.selectAll("svg").selectAll("circle")
			.attr("r", function(d){return d.size});
			
		d3.selectAll("svg").selectAll("text")
			.text(function(d){return d.text})
			.style("text-anchor", "middle")
	}
	
	function yesResponse() {
			root = root.left;
			try{
				document.getElementById("question").innerHTML = "Does the patient display problems with " + root.rule.substr(0, root.rule.indexOf('<')-1) + '?';
				//update log
				symptomText = symptomText + "Problems with " + root.rule.substr(0, root.rule.indexOf('<')-1) + "<br>";
			}
			catch(err){
				document.getElementById("question").innerHTML = "The patient likely has " + root.Code;

			}
			if(!root.right){
				document.getElementById("yesButton").disabled = true;
  		  	    document.getElementById("noButton").disabled = true;
			}
			else{
				document.getElementById("symptoms").innerHTML = symptomText;
			}

		
	}
	
	function noResponse() {
			root = root.right;
			try{
				document.getElementById("question").innerHTML = "Does the patient display problems with " + root.rule.substr(0, root.rule.indexOf('<')-1) + '?';
				//update log
				symptomText = symptomText + "No problems with " + root.rule.substr(0, root.rule.indexOf('<')-1) + "<br>";
			}
			catch(err){
				document.getElementById("question").innerHTML = "The patient likely has " + root.Code;			
			}
			if(!root.right){
				document.getElementById("yesButton").disabled = true;
  		  	    document.getElementById("noButton").disabled = true;
			}
			else{
				document.getElementById("symptoms").innerHTML = symptomText;
			}
	}

</script>
</html>
